{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["'use strict';\n\nimport * as utils from '@iobroker/adapter-core';\nimport axios, { type AxiosRequestConfig } from 'axios';\nimport { promises as dns } from 'node:dns';\n\nclass Dnscope extends utils.Adapter {\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'dnscope',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n    }\n\n    private async onReady(): Promise<void> {\n        try {\n            const instObj = await this.getForeignObjectAsync(`system.adapter.${this.namespace}`);\n            if (instObj?.common.schedule && instObj.common.schedule === '*/10 * * * *') {\n                instObj.common.schedule = `${Math.floor(Math.random() * 60)} */10 * * * *`;\n\n                this.log.info(`Default schedule found and adjusted to spread calls better!`);\n                await this.setForeignObject(`system.adapter.${this.namespace}`, instObj);\n\n                this.terminate ? this.terminate() : process.exit(0);\n                return;\n            }\n        } catch (err) {\n            this.log.error(`Could not check or adjust the schedule: ${err.message}`);\n        }\n\n        if (this.config.ipv4) {\n            const currentIP: string | null = await this.checkipv4();\n            const lastIP: string | null = await this.resolveDNSv4(this.config.domain);\n            if ((this.config.onlyChanges && currentIP !== lastIP) || !this.config.onlyChanges) {\n                await this.updateDNSv4(currentIP);\n            } else {\n                this.log.debug('no changes for IPv4');\n            }\n        }\n\n        if (this.config.ipv6) {\n            const currentIP: string | null = await this.checkipv6();\n            const lastIP: string | null = await this.resolveDNSv6(this.config.domain);\n            if ((this.config.onlyChanges && currentIP !== lastIP) || !this.config.onlyChanges) {\n                await this.updateDNSv6(currentIP);\n            } else {\n                this.log.debug('no changes for IPv6');\n            }\n        }\n\n        await this.delay(10_000);\n        this.terminate ? this.terminate() : process.exit(0);\n    }\n\n    private onUnload(callback: () => void): void {\n        try {\n            this.log.debug('cleaned everything up...');\n            callback();\n        } catch (e) {\n            this.log.error(`Unload Error: ${e}`);\n            callback();\n        }\n    }\n\n    private async checkipv4(): Promise<string | null> {\n        const url = 'https://ipinfo.io/json';\n        try {\n            const dataRequest = await axios({\n                method: 'get',\n                url: url,\n                timeout: 10000,\n                responseType: 'json',\n            });\n\n            const data = dataRequest.data;\n\n            await this.setObjectNotExistsAsync('data.currentIPv4', {\n                type: 'state',\n                common: {\n                    name: 'current IPv4',\n                    type: 'string',\n                    role: 'info.ip',\n                    read: true,\n                    write: false,\n                },\n                native: {},\n            });\n            const state = await this.getStateAsync('data.currentIPv4');\n\n            if (data?.ip !== state?.val) {\n                await this.setStateChangedAsync('data.currentIPv4', data?.ip ? data.ip : 'not available', true);\n            }\n            return data?.ip;\n\n            this.log.debug(JSON.stringify(dataRequest.data));\n        } catch (error) {\n            this.log.warn(`ipinfo.io is not available: ${error.toString()}`);\n            return null;\n        }\n    }\n\n    private async checkipv6(): Promise<string | null> {\n        const url = 'https://v6.ipinfo.io/json';\n        try {\n            const dataRequest = await axios({\n                method: 'get',\n                url: url,\n                timeout: 10000,\n                responseType: 'json',\n            });\n\n            const data = dataRequest.data;\n\n            await this.setObjectNotExistsAsync('data.currentIPv6', {\n                type: 'state',\n                common: {\n                    name: 'current IPv6',\n                    type: 'string',\n                    role: 'info.ip',\n                    read: true,\n                    write: false,\n                },\n                native: {},\n            });\n            const state = await this.getStateAsync('data.currentIPv6');\n\n            if (data?.ip !== state?.val) {\n                await this.setStateChangedAsync('data.currentIPv6', data?.ip ? data.ip : 'not available', true);\n            }\n            return data?.ip;\n\n            this.log.debug(JSON.stringify(dataRequest.data));\n        } catch (error) {\n            this.log.warn(`ipinfo.io is not available: ${error.toString()}`);\n            return null;\n        }\n    }\n\n    private async resolveDNSv4(domain: string): Promise<string | null> {\n        try {\n            const addresses: string | null = (await dns.resolve4(domain)).toString();\n            this.log.debug(`IPv4 for ${domain}: ${addresses}`);\n            return addresses;\n        } catch (error) {\n            this.log.warn(`Error during DNS resolution: ${error.toString()}`);\n            return null;\n        }\n    }\n\n    private async resolveDNSv6(domain: string): Promise<string | null> {\n        try {\n            const addresses: string | null = (await dns.resolve6(domain)).toString();\n            this.log.debug(`IPv6 for ${domain}: ${addresses}`);\n            return addresses;\n        } catch (error) {\n            this.log.warn(`Error during DNS resolution: ${error.toString()}`);\n            return null;\n        }\n    }\n\n    private async updateDNSv4(currentIPv4: string | null): Promise<string | null> {\n        let url = '' as string;\n        let username = null as null | string;\n        let password = null as null | string;\n        const domain: string = this.config.domain;\n\n        switch (this.config.dyndnsServive) {\n            case 'duckdns':\n                url = `https://www.duckdns.org/update?domains=${domain.split('.')[0]}&token=${this.config.duckdnsToken}&ip=${currentIPv4}`;\n                break;\n            case 'ipv64':\n                url = `https://ipv64.net/update.php?key=${this.config.ipv64Token}&domain=${domain}&ip=${currentIPv4}`;\n                break;\n            case 'noip':\n                url = `https://dynupdate.no-ip.com/nic/update?hostname=${domain}&myip=${currentIPv4}`;\n                password = this.config.noipPassword;\n                username = this.config.noipUser;\n                break;\n            case 'custom':\n                url = this.config.customURL;\n                break;\n            case 'dynv6':\n                url = `https://ipv4.dynv6.com/api/update?ipv4=${currentIPv4}&token=${this.config.dynv6Token}`;\n                break;\n        }\n\n        try {\n            const config: AxiosRequestConfig = {\n                method: 'get',\n                url: url,\n                timeout: 10_000,\n                auth: username && password ? { username, password } : undefined,\n            };\n\n            const response = await axios(config);\n            this.log.debug(`DNS Update State for IPv4: ${JSON.stringify(response.data)}`);\n            return 'OK';\n        } catch (error) {\n            this.log.error(`Error in the request for IPv4: ${error.message}`);\n            return 'not OK';\n        }\n    }\n\n    private async updateDNSv6(currentIPv6: string | null): Promise<string | null> {\n        let url = '';\n        let username = null;\n        let password = null;\n        const domain = this.config.domain;\n\n        switch (this.config.dyndnsServive) {\n            case 'duckdns':\n                url = `https://www.duckdns.org/update?domains=${domain.split('.')[0]}&token=${this.config.duckdnsToken}&ipv6=${currentIPv6}`;\n                break;\n            case 'ipv64':\n                url = `https://ipv64.net/nic/update?key=${this.config.ipv64Token}&domain=${domain}&ip6=${currentIPv6}`;\n                break;\n            case 'noip':\n                url = `https://dynupdate.no-ip.com/nic/update?hostname=${domain}&myip=${currentIPv6}`;\n                password = this.config.noipPassword;\n                username = this.config.noipUser;\n                break;\n            case 'custom':\n                url = this.config.customURL;\n                break;\n            case 'dynv6':\n                url = `https://ipv6.dynv6.com/api/update?ipv6=${currentIPv6}&token=${this.config.dynv6Token}`;\n                break;\n        }\n\n        try {\n            const config: AxiosRequestConfig = {\n                method: 'get',\n                url: url,\n                timeout: 10000,\n                auth: username && password ? { username, password } : undefined,\n            };\n\n            const response = await axios(config);\n            this.log.debug(`DNS Update State for IPv6: ${JSON.stringify(response.data)}`);\n            return 'OK';\n        } catch (error) {\n            this.log.error(`Error in the request for IPv6: ${error.message}`);\n            return 'not OK';\n        }\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Dnscope(options);\n} else {\n    // otherwise start the instance directly\n    (() => new Dnscope())();\n}\n"],
  "mappings": "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",
  "names": ["axios", "dns"]
}
